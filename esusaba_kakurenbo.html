<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</title>
    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f0f4f8; color: #333; max-width: 950px; margin: 0 auto; padding: 20px; }
        h1 { text-align: center; color: #2c3e50; border-bottom: 3px solid #3498db; padding-bottom: 10px; }
        .container { display: flex; gap: 20px; flex-wrap: wrap; }
        .card { background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); flex: 1; min-width: 350px; }
        h3 { margin-top: 0; color: #34495e; border-left: 5px solid #3498db; padding-left: 10px; }
        .member-input { margin-bottom: 5px; display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .score-row { border-bottom: 1px solid #eee; padding: 15px 0; }
        .bonus-group { font-size: 0.85em; margin-top: 5px; color: #666; display: flex; gap: 10px; }
        .bonus-item { display: flex; align-items: center; gap: 4px; background: #eef7ff; padding: 2px 8px; border-radius: 4px; }
        select, button { padding: 8px; border-radius: 4px; border: 1px solid #ccc; }
        button { background-color: #3498db; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background-color: #2980b9; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; background: white; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #3498db; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
    </style>
</head>
<body>

    <h1>ğŸ® ãˆã™é¯–ã‹ãã‚Œã‚“ã¼å¤§ä¼šï¼ï¼</h1>

    <div class="container">
        <div class="card">
            <h3>1. å‚åŠ è€…ç™»éŒ² (10å)</h3>
            <div id="memberInputs"></div> <button onclick="updateMemberList()" style="width: 100%; margin-top: 10px;">ãƒ¡ãƒ³ãƒãƒ¼ã‚’ç¢ºå®šã™ã‚‹</button>
        </div>

        <div class="card">
            <h3>2. è©¦åˆçµæœã®å…¥åŠ›</h3>
            <div class="score-row" style="background: #fff5f5; padding: 10px; border-radius: 8px;">
                <strong>ğŸ‘¹ é¬¼:</strong>
                <select id="oniSelect"><option value="">é¸æŠ</option></select>
                <span>ç²å¾—: <strong id="oniTotalDisplay">0</strong> pt</span>
            </div>
            <div id="childrenInputs"></div> <button onclick="saveMatch()" id="saveBtn" style="width: 100%; background-color: #e67e22; margin-top: 15px; height: 50px; font-size: 1.1em;">è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ</button>
        </div>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h3>3. ç·åˆãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
        <table id="rankingTable">
            <thead>
                <tr><th>é †ä½</th><th>åå‰</th><th>ç·åˆãƒã‚¤ãƒ³ãƒˆ</th></tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>

    <script>
        // ã€é‡è¦ã€‘ã‚ãªãŸã®GASã®URLã‚’ã“ã“ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
        const GAS_URL = "https://script.google.com/macros/s/AKfycbyy6D8cMTuyVv4Zdale2P1qJ3uvQO7AYqfgz2-7c2g545lgoi8ChYgtiDG6C14oLJf7/exec"; 

        // ãƒšãƒ¼ã‚¸ãŒå®Œå…¨ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰å®Ÿè¡Œã™ã‚‹
        window.onload = async function() {
            initForm();      // å…¥åŠ›æ ã‚’ä½œæˆ
            await fetchRanking(); // ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—
        };

        function initForm() {
            // ãƒ¡ãƒ³ãƒãƒ¼æ ã®ä½œæˆ
            const mDiv = document.getElementById('memberInputs');
            if(mDiv) {
                let html = "";
                for (let i = 1; i <= 10; i++) {
                    html += `<input type="text" class="member-input" id="m${i}" placeholder="å‚åŠ è€… ${i}">`;
                }
                mDiv.innerHTML = html;
            }

            // å­ã®æ ã®ä½œæˆ
            const cDiv = document.getElementById('childrenInputs');
            if(cDiv) {
                let html = "";
                for (let i = 1; i <= 4; i++) {
                    html += `
                    <div class="score-row">
                        <div>
                            ğŸƒ å­${i}: <select id="ko${i}Select" class="ko-sel"><option value="">é¸æŠ</option></select>
                            <select id="ko${i}Time" onchange="calculatePoints()">
                                <option value="0">3~2åˆ†(0pt)</option>
                                <option value="1">2~1åˆ†(1pt)</option>
                                <option value="2">1åˆ†~çµ‚äº†(2pt)</option>
                                <option value="3">é€ƒã’åˆ‡ã‚Š(3pt)</option>
                            </select>
                        </div>
                        <div class="bonus-group">
                            <label class="bonus-item"><input type="checkbox" id="ko${i}B1" onchange="calculatePoints()"> B1:æ•µé™£(+0.5)</label>
                            <label class="bonus-item"><input type="checkbox" id="ko${i}B2" onchange="calculatePoints()"> B2:æœ€æ•µé™£(+0.5)</label>
                        </div>
                    </div>`;
                }
                cDiv.innerHTML = html;
            }
        }

        let scores = {};

        async function fetchRanking() {
            try {
                const response = await fetch(GAS_URL);
                scores = await response.json();
                updateRanking();
            } catch (e) {
                console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", e);
            }
        }

        function updateMemberList() {
            const oniDropdown = document.getElementById('oniSelect');
            const koDropdowns = document.querySelectorAll('.ko-sel');
            const optionsHtml = ['<option value="">é¸æŠ</option>'];
            for (let i = 1; i <= 10; i++) {
                const name = document.getElementById(`m${i}`).value;
                if (name) {
                    optionsHtml.push(`<option value="${name}">${name}</option>`);
                    if (!(name in scores)) scores[name] = 0;
                }
            }
            oniDropdown.innerHTML = optionsHtml.join('');
            koDropdowns.forEach(sel => sel.innerHTML = optionsHtml.join(''));
            alert("ãƒ¡ãƒ³ãƒãƒ¼å€™è£œã‚’æ›´æ–°ã—ã¾ã—ãŸ");
        }

        function calculatePoints() {
            let oniBonus = 0;
            for (let i = 1; i <= 4; i++) {
                const timeVal = parseInt(document.getElementById(`ko${i}Time`).value);
                if (timeVal === 0) oniBonus += 3;
                else if (timeVal === 1) oniBonus += 2;
                else if (timeVal === 2) oniBonus += 1;
            }
            document.getElementById('oniTotalDisplay').innerText = oniBonus;
            return oniBonus;
        }

        async function saveMatch() {
            const oniName = document.getElementById('oniSelect').value;
            if (!oniName) { alert("é¬¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

            const matchData = {
                oniName: oniName,
                oniPoints: calculatePoints(),
                children: []
            };

            for (let i = 1; i <= 4; i++) {
                const koName = document.getElementById(`ko${i}Select`).value;
                if (!koName) continue;
                let p = parseInt(document.getElementById(`ko${i}Time`).value);
                if (document.getElementById(`ko${i}B1`).checked) p += 0.5;
                if (document.getElementById(`ko${i}B2`).checked) p += 0.5;
                matchData.children.push({ name: koName, points: p });
            }

            const btn = document.getElementById('saveBtn');
            btn.innerText = "ä¿å­˜ä¸­...";
            btn.disabled = true;

            try {
                await fetch(GAS_URL, { method: "POST", body: JSON.stringify(matchData) });
                alert("ä¿å­˜å®Œäº†ï¼");
                await fetchRanking();
                resetInputs();
            } catch (e) {
                alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ");
            } finally {
                btn.innerText = "è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ";
                btn.disabled = false;
            }
        }

        function resetInputs() {
            for (let i = 1; i <= 4; i++) {
                document.getElementById(`ko${i}B1`).checked = false;
                document.getElementById(`ko${i}B2`).checked = false;
                document.getElementById(`ko${i}Time`).value = "0";
            }
            calculatePoints();
        }

        function updateRanking() {
            const tbody = document.querySelector('#rankingTable tbody');
            tbody.innerHTML = '';
            const sorted = Object.entries(scores).sort((a, b) => b[1] - a[1]);
            sorted.forEach((item, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td>${index + 1}</td><td>${item[0]}</td><td>${item[1].toFixed(1)} pt</td>`;
            });
        }
    </script>
</body>
</html>
