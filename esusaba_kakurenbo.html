<script>
    // ã€é‡è¦ã€‘ã“ã“ã«ã‚¹ãƒ†ãƒƒãƒ—3ã§å–å¾—ã—ãŸã‚¦ã‚§ãƒ–ã‚¢ãƒ—ãƒªã®URLã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„
    const GAS_URL = "https://script.google.com/macros/s/AKfycbyy6D8cMTuyVv4Zdale2P1qJ3uvQO7AYqfgz2-7c2g545lgoi8ChYgtiDG6C14oLJf7/exec"; 

    // 10äººåˆ†ã®å…¥åŠ›æ ã‚’ä½œæˆ
    const memberInputsDiv = document.getElementById('memberInputs');
    for (let i = 1; i <= 10; i++) {
        memberInputsDiv.innerHTML += `<input type="text" class="member-input" id="m${i}" placeholder="å‚åŠ è€… ${i}">`;
    }

    // å­4äººåˆ†ã®å…¥åŠ›æ ã‚’ä½œæˆ
    const childrenInputsDiv = document.getElementById('childrenInputs');
    for (let i = 1; i <= 4; i++) {
        childrenInputsDiv.innerHTML += `
            <div class="score-row">
                <div>
                    ğŸƒ å­${i}: <select id="ko${i}Select" class="ko-sel"><option value="">é¸æŠ</option></select>
                    <select id="ko${i}Time" onchange="calculatePoints()">
                        <option value="0">3~2åˆ†(0pt)</option>
                        <option value="1">2~1åˆ†(1pt)</option>
                        <option value="2">1åˆ†~çµ‚äº†(2pt)</option>
                        <option value="3">é€ƒã’åˆ‡ã‚Š(3pt)</option>
                    </select>
                </div>
                <div class="bonus-group">
                    <label class="bonus-item"><input type="checkbox" id="ko${i}B1" onchange="calculatePoints()"> B1:æ•µé™£(+0.5)</label>
                    <label class="bonus-item"><input type="checkbox" id="ko${i}B2" onchange="calculatePoints()"> B2:æœ€æ•µé™£(+0.5)</label>
                </div>
            </div>`;
    }

    let scores = {};

    // ãƒšãƒ¼ã‚¸ã‚’é–‹ã„ãŸç¬é–“ã«ã€ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰æœ€æ–°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å–å¾—ã™ã‚‹
    window.onload = async () => {
        await fetchRanking();
    };

    async function fetchRanking() {
        try {
            const response = await fetch(GAS_URL);
            scores = await response.json();
            updateRanking();
        } catch (e) {
            console.error("ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ", e);
        }
    }

    function updateMemberList() {
        const oniDropdown = document.getElementById('oniSelect');
        const koDropdowns = document.querySelectorAll('.ko-sel');
        const optionsHtml = ['<option value="">é¸æŠ</option>'];
        for (let i = 1; i <= 10; i++) {
            const name = document.getElementById(`m${i}`).value;
            if (name) {
                optionsHtml.push(`<option value="${name}">${name}</option>`);
                if (!(name in scores)) scores[name] = 0;
            }
        }
        oniDropdown.innerHTML = optionsHtml.join('');
        koDropdowns.forEach(sel => sel.innerHTML = optionsHtml.join(''));
        alert("ãƒ¡ãƒ³ãƒãƒ¼å€™è£œã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆä¿å­˜ã¯ã•ã‚Œã¾ã›ã‚“ï¼‰");
    }

    function calculatePoints() {
        let oniBonus = 0;
        for (let i = 1; i <= 4; i++) {
            const timeVal = parseInt(document.getElementById(`ko${i}Time`).value);
            if (timeVal === 0) oniBonus += 3;
            else if (timeVal === 1) oniBonus += 2;
            else if (timeVal === 2) oniBonus += 1;
        }
        document.getElementById('oniTotalDisplay').innerText = oniBonus;
        return oniBonus;
    }

    async function saveMatch() {
        const oniName = document.getElementById('oniSelect').value;
        if (!oniName) { alert("é¬¼ã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }

        const matchData = {
            oniName: oniName,
            oniPoints: calculatePoints(),
            children: []
        };

        for (let i = 1; i <= 4; i++) {
            const koName = document.getElementById(`ko${i}Select`).value;
            if (!koName) continue;
            let p = parseInt(document.getElementById(`ko${i}Time`).value);
            if (document.getElementById(`ko${i}B1`).checked) p += 0.5;
            if (document.getElementById(`ko${i}B2`).checked) p += 0.5;
            matchData.children.push({ name: koName, points: p });
        }

        // --- ã“ã“ã§ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ(GAS)ã«ãƒ‡ãƒ¼ã‚¿ã‚’é£›ã°ã™ ---
        const btn = document.querySelector('button[onclick="saveMatch()"]');
        btn.innerText = "ä¿å­˜ä¸­...";
        btn.disabled = true;

        try {
            await fetch(GAS_URL, {
                method: "POST",
                body: JSON.stringify(matchData)
            });
            alert("ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã«ä¿å­˜ã—ã¾ã—ãŸï¼");
            await fetchRanking(); // æœ€æ–°ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚’å†èª­ã¿è¾¼ã¿
            resetInputs();
        } catch (e) {
            alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸã€‚GASã®URLã‚„è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚");
        } finally {
            btn.innerText = "è©¦åˆçµæœã‚’ä¿å­˜ãƒ»é›†è¨ˆ";
            btn.disabled = false;
        }
    }

    function resetInputs() {
        for (let i = 1; i <= 4; i++) {
            document.getElementById(`ko${i}B1`).checked = false;
            document.getElementById(`ko${i}B2`).checked = false;
            document.getElementById(`ko${i}Time`).value = "0";
        }
        calculatePoints();
    }

    function updateRanking() {
        const tbody = document.querySelector('#rankingTable tbody');
        tbody.innerHTML = '';
        const sorted = Object.entries(scores)
            .filter(([name]) => name !== "")
            .sort((a, b) => b[1] - a[1]);

        sorted.forEach((item, index) => {
            const row = tbody.insertRow();
            row.innerHTML = `<td>${index + 1}</td><td>${item[0]}</td><td>${item[1].toFixed(1)} pt</td>`;
        });
    }
</script>